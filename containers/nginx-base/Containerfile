# ──────────────────────────────────────────────────────────────
# nginx-base — Hardened Nginx base image
# ──────────────────────────────────────────────────────────────
# Usage:
#   FROM ghcr.io/OWNER/nginx-base:latest
#   COPY dist/ /usr/share/nginx/html/
# ──────────────────────────────────────────────────────────────
FROM docker.io/library/nginx:1.27-alpine

# Install tini (PID 1 init) and create non-root user
RUN apk add --no-cache tini \
    && addgroup -g 1000 -S app \
    && adduser -u 1000 -S -G app -h /nonexistent -s /sbin/nologin app \
    && mkdir -p /var/cache/nginx /var/log/nginx /var/run \
    && chown -R app:app /var/cache/nginx /var/log/nginx /var/run /usr/share/nginx/html

# Harden: disable server tokens, listen on 8080
RUN sed -i 's/listen\s*80;/listen 8080;/g' /etc/nginx/conf.d/default.conf \
    && sed -i '/http {/a \    server_tokens off;' /etc/nginx/nginx.conf \
    && sed -i 's|pid\s*/run/nginx.pid;|pid /var/run/nginx.pid;|' /etc/nginx/nginx.conf

EXPOSE 8080

USER app

ENTRYPOINT ["tini", "--"]
CMD ["nginx", "-g", "daemon off;"]

HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD wget -qO /dev/null http://localhost:8080/ || exit 1
